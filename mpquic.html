<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multipath QUIC &mdash; Modern Multipath Transport Protocols 2022 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multipath TCP on recent Linux kernels" href="mptcp-linux.html" />
    <link rel="prev" title="Multipath TCP" href="mptcp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> Modern Multipath Transport Protocols
          </a>
              <div class="version">
                alpha
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="principles.html">Principles of multipath transport</a></li>
<li class="toctree-l1"><a class="reference internal" href="singlepath.html">Single path transport protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="quic.html">QUIC</a></li>
<li class="toctree-l1"><a class="reference internal" href="mptcp.html">Multipath TCP</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Multipath QUIC</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quic-connection-migration">QUIC connection migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multipath-extensions-for-quic">Multipath extensions for QUIC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mptcp-linux.html">Multipath TCP on recent Linux kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="biblio.html">Bibliography</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Modern Multipath Transport Protocols</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Multipath QUIC</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/obonaventure/mmtp-book/blob/mainmpquic.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="multipath-quic">
<h1>Multipath QUIC<a class="headerlink" href="#multipath-quic" title="Permalink to this headline"></a></h1>
<p>As the development of QUIC progressed within the IETF, academic researchers have started to explore how QUIC could be extended with multipath capabilities. The first approaches built upon Google’s version of QUIC. The first prototype was implemented inside <code class="docutils literal notranslate"><span class="pre">quic-go</span></code> <span id="id1">[<a class="reference internal" href="biblio.html#id8889" title="Quentin De Coninck and Olivier Bonaventure. Multipath quic: design and evaluation. In Proceedings of the 13th international conference on emerging networking experiments and technologies, 160–166. 2017.">69</a>]</span>. A second version of the protocol which can be easily extended using plugins was then proposed inside <code class="docutils literal notranslate"><span class="pre">picoquic</span></code> <span id="id2">[<a class="reference internal" href="biblio.html#id8897" title="Quentin De Coninck, François Michel, Maxime Piraux, Florentin Rochet, Thomas Given-Wilson, Axel Legay, Olivier Pereira, and Olivier Bonaventure. Pluginizing quic. In Proceedings of the ACM Special Interest Group on Data Communication, pages 59–74. 2019.">70</a>]</span>. An alternative approach was proposed in parallel <span id="id3">[<a class="reference internal" href="biblio.html#id8890" title="Tobias Viernickel, Alexander Froemmgen, Amr Rizk, Boris Koldehofe, and Ralf Steinmetz. Multipath quic: a deployable multipath transport protocol. In 2018 IEEE International Conference on Communications (ICC), 1–7. IEEE, 2018.">71</a>]</span>. The most recent solutions <span id="id4">[<a class="reference internal" href="biblio.html#id8891" title="Quentin De Coninck and Olivier Bonaventure. Multiflow quic: a generic multipath transport protocol. IEEE Communications Magazine, 59(5):108–113, 2021.">72</a>, <a class="reference internal" href="biblio.html#id8898" title="Zhilong Zheng, Yunfei Ma, Yanmei Liu, Furong Yang, Zhenyu Li, Yuanbo Zhang, Jiuhai Zhang, Wei Shi, Wentao Chen, Ding Li, and others. Xlink: qoe-driven multi-path quic transport in large-scale video services. In Proceedings of the 2021 ACM SIGCOMM 2021 Conference, 418–432. 2021.">73</a>]</span> leverage the most recent QUIC specification as described in this document.</p>
<p>Discussions within the IETF took some time to start, despite early proposals <span id="id5">[<a class="reference internal" href="biblio.html#id8896" title="Quentin De Coninck and Olivier Bonaventure. Multipath Extension for QUIC. Internet-Draft draft-deconinck-multipath-quic-00, Internet Engineering Task Force, October 2017. Work in Progress. URL: https://datatracker.ietf.org/doc/html/draft-deconinck-multipath-quic-00.">74</a>]</span>. Recently, the QUIC working group adopted <span id="id6">[<a class="reference internal" href="biblio.html#id8892" title="Yanmei Liu, Yunfei Ma, Quentin De Coninck, Olivier Bonaventure, Christian Huitema, and Mirja Kühlewind. Multipath Extension for QUIC. Internet-Draft draft-lmbdhk-quic-multipath-00, Internet Engineering Task Force, October 2021. Work in Progress. URL: https://datatracker.ietf.org/doc/html/draft-lmbdhk-quic-multipath-00.">75</a>]</span> as a starting point for the development of an IETF specification for multipath QUIC. It combines the ideas initially proposed in three different drafts <span id="id7">[<a class="reference internal" href="biblio.html#id8895" title="Yanmei Liu, Yunfei Ma, Christian Huitema, Qing An, and Zhenyu Li. Multipath Extension for QUIC. Internet-Draft draft-liu-multipath-quic-04, Internet Engineering Task Force, September 2021. Work in Progress. URL: https://datatracker.ietf.org/doc/html/draft-liu-multipath-quic-04.">76</a>, <a class="reference internal" href="biblio.html#id8893" title="Quentin De Coninck and Olivier Bonaventure. Multipath Extensions for QUIC (MP-QUIC). Internet-Draft draft-deconinck-quic-multipath-07, Internet Engineering Task Force, May 2021. Work in Progress. URL: https://datatracker.ietf.org/doc/html/draft-deconinck-quic-multipath-07.">77</a>, <a class="reference internal" href="biblio.html#id8894" title="Christian Huitema. QUIC Multipath Negotiation Option. Internet-Draft draft-huitema-quic-mpath-option-01, Internet Engineering Task Force, September 2021. Work in Progress. URL: https://datatracker.ietf.org/doc/html/draft-huitema-quic-mpath-option-01.">78</a>]</span>.</p>
<p>In this chapter, we explain the two “levels” of Multipath support that exist for QUIC. We start with the connection migration facility which is supported by QUIC <span id="id8">[<a class="reference internal" href="biblio.html#id8812" title="J. Iyengar (Ed.) and M. Thomson (Ed.). QUIC: A UDP-Based Multiplexed and Secure Transport. RFC 9000 (Proposed Standard), May 2021. URL: https://www.rfc-editor.org/rfc/rfc9000.txt, doi:10.17487/RFC9000.">25</a>]</span>. This feature was included in the initial specification to cope with NAT rebindings but also provides support for handovers. Connection migration mainly enables a QUIC connection to switch from one path to another. We then describe in more details the ongoing effort to define Multipath QUIC which provides the ability to use two or more paths simultaneously.</p>
<section id="quic-connection-migration">
<h2>QUIC connection migration<a class="headerlink" href="#quic-connection-migration" title="Permalink to this headline"></a></h2>
<p>As explained in <a class="reference internal" href="quic.html#chapter-quic"><span class="std std-ref">QUIC</span></a>, QUIC uses connection identifiers. These connection identifiers are used for different purposes. On the server side, they were initially proposed to allow load-balancers to spread the packets of different connections to different servers without having to maintain any state. In addition, QUIC ‘s connection identifiers also enable clients to migrate connections from one path to another or even on the same path.</p>
<p>QUIC connection migrations occur in two steps. As an example, we consider client triggered migrations. These are the most important from a deployment viewpoint. A client can decide to migrate its connection for various reasons, including privacy and performance. A common scenario is a smartphone that moves and goes progressively out of reach of its Wi-Fi access point. When the smartphone notices a decrease in performance of the Wi-Fi network (lower signal to noise ratio, more losses or retransmissions, …), it can decide to migrate the QUIC connection over the cellular interface. A naive solution would be to simply move the QUIC packets from one interface to another using the same connection identifiers. This is illustrated in <a class="reference internal" href="#fig-quic-naive-migration"><span class="std std-numref">Fig. 83</span></a>. The QUIC connection was established from the client IP address, <span class="math notranslate nohighlight">\(IP_{\alpha}\)</span>, to the server’s IP address, <span class="math notranslate nohighlight">\(IP_S\)</span>. The first two packets show a simple exchange over this connection. Before sending its second packet, the client decides to switch to the cellular interface. This interface is illustrated in red and its IP address is <span class="math notranslate nohighlight">\(IP_{\beta}\)</span>.</p>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<span class="docutils literal">\tikzmath{\c1=1;\c2=1.5; \s1=8; \s2=8.5; \max=6; }
\tikzstyle{every node}=[font=\small]
\tikzstyle{arrow} = [thick,-&gt;,&gt;=stealth]
\tikzset{state/.style={rectangle, dashed, draw, fill=white} }
\node [black, fill=white] at (\c1,\max) {Client};
\node [black, fill=white] at (\s1,\max) {Server};

\draw[black,thick,-&gt;] (\c1-0.5,\max-0.5) -- (\c1-0.5,0.5);
\draw[red,dashed,thick,-&gt;] (\c1+0.5,\max-0.5) -- (\c1+0.5,0.5);
\draw[black,thick,-&gt;] (\s1,\max-0.5) -- (\s1,0.5);
\node [black, fill=white] at (\c1-0.5,\max-0.5) {$IP_{\alpha}$};
\node [red, fill=white] at (\c1+0.5,\max-0.5) {$IP_{\beta}$};
\node [black, fill=white] at (\s1,\max-0.5) {$IP_{S}$};

\tikzmath{\y=\max-1;}
\draw[black,thick, -&gt;] (\c1-0.5,\y) -- (\s1,\y-1) node [midway, align=center, fill=white]  {src=$IP_{\alpha}$,dst=$IP_S$,DCID=$\mu$\\1-RTT(...)};
\draw[black,thick, -&gt;] (\s1,\y-1) -- (\c1-0.5,\y-2) node [midway, align=center, fill=white]  {src=$IP_S$,dst=$IP_{\alpha}$\\1-RTT(...)};
\draw[red,thick, -&gt;] (\c1+0.5,\y-2) -- (\s1,\y-3) node [midway, align=center, fill=white]  {src=$IP_{\beta}$,dst=$IP_S$,DCID=$\mu$\\1-RTT(...)};
\draw[red,thick, -&gt;] (\s1,\y-3) -- (\c1+0.5,\y-4) node [midway, align=center, fill=white]  {src=$IP_S$,dst=$IP_{\beta}$\\1-RTT(...)};</span>)</p>
<p>! LaTeX Error: File `bytefield.sty' not found.

Type X to quit or &lt;RETURN&gt; to proceed,
or enter new name. (Default extension: sty)

Enter file name: 
! Emergency stop.
&lt;read *&gt; 
         
l.16 \\tikzset
             {router/.style = {rectangle, draw, text centered, minimum heigh...

!  ==&gt; Fatal error occurred, no output PDF file produced!
Transcript written on tikz-272136ca52b0be2749b89be044e764f3d2ca6df8.log.
&quot;</p>
</div>
<p><span class="caption-number">Fig. 83 </span><span class="caption-text">A naive approach to migrate a QUIC connection from Wi-Fi to cellular</span></p>
</div><p>Unfortunately, this naive approach is not secure. Consider a server that receives a QUIC packet from the smartphone’s cellular interface. This packet originates from a different IP address, but contains the same connection identifier. If the server accepts this packet and decides to reply over the cellular path, this creates several security risks. First, consider an attacker who managed to capture a packet sent by the client over the Wi-Fi network. By sending again this unmodified QUIC packet from its own IP address, the attacker could disrupt the ongoing connection by forcing the server to send replies to its own IP address. Furthermore, this also opens a risk of denial of service attacks if the packet copied by the attacker contains a request for a large object. QUIC copes with these problems by using path-specific connection identifiers and the path validation mechanism.</p>
<p>A QUIC connection identifier is always bound to a specific IP address. When a QUIC host receives a QUIC packet, it verifies that the packet originates from the associated source. The QUIC specification does not prescribe how this verification can be done, but a simple approach is to encode a hash of the source IP address inside the connection identifier.</p>
<p>When a QUIC connection starts the server verifies that the client receives the packets that it sends to prevent attacks from spoofed addresses. This verification is part of the handshake and may in some cases involve the utilization of <code class="docutils literal notranslate"><span class="pre">RETRY</span></code> packets. Consider a malicious client using address <span class="math notranslate nohighlight">\(IP_{\alpha}\)</span> but wishes to create a denial of service attack against address <span class="math notranslate nohighlight">\(IP_{\mu}\)</span>. This client could initiate a connection with a server using address <span class="math notranslate nohighlight">\(IP_{\alpha}\)</span>, request a large object and send a packet spoofing address <span class="math notranslate nohighlight">\(IP_{\mu}\)</span> to force the server to send all reply packets to the victim. To cope with this attack, a QUIC server must first validate a new client address before sending a large number of packets. To validate a new client address, the server simply needs to send a <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> frame that contains a random number. This frame is encrypted using the connection keys, like all QUIC frames. Upon reception of this frame, the client can extract the random number and return it in a <code class="docutils literal notranslate"><span class="pre">PATH_RESPONSE</span></code> frame to the server. Upon reception of this frame, the server has the confirmation that the client can also receive packets on the new address and thus it can safely be used. The client can also validate a path as shown below.</p>
<p>To enable a client to migrate a QUIC connection, the server must first advertise at least one different connection identifier. This is done with the <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame. The client uses the additional connection identifier advertised by the server to try to move the connection to a new path. The client cannot use a new path before having the guarantee that the server can reply over the new path. To verify that the new path is bidirectional, the client sends a <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> frame in a QUIC packet that uses the new connection identifier over the new path. This frame mainly contains a 64 bits random nonce that must be echoed by the server. It also includes some padding to check the path’s MTU as done during the handshake. Upon reception of this packet, the server detects an attempt to use a new path with the new connection identifier. It replies with a <code class="docutils literal notranslate"><span class="pre">PATH_RESPONSE</span></code> frame that echoes the client nonce. The server may also perform its own path validation by sending a <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> with a different nonce in the same packet as the <code class="docutils literal notranslate"><span class="pre">PATH_RESPONSE</span></code>. The client considers that the path has been validated upon reception of the valid <code class="docutils literal notranslate"><span class="pre">PATH_RESPONSE</span></code> frame. The packets that contain the <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> and <code class="docutils literal notranslate"><span class="pre">PATH_RESPONSE</span></code> frames are usually padded with <code class="docutils literal notranslate"><span class="pre">PADDING</span></code> frames. The client then switches to the new connection identifier and the new path for all the frames that it sends. It may still continue to receive packets over the former path for some time. The server will switch to the new path once it has received a response to its <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> if it decided to validate the new path. Otherwise, the reception of a QUIC packet that contains other frames than <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code>, <code class="docutils literal notranslate"><span class="pre">PATH_RESPONSE</span></code>, <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> or <code class="docutils literal notranslate"><span class="pre">PADDING</span></code> also indicates that the path is active. The client could send a <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame together with the <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> frame if the client uses a non-null connection identifier and it has not sent a <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame before. This is illustrated in <a class="reference internal" href="#fig-quic-client-migration"><span class="std std-numref">Fig. 84</span></a>.</p>
<div class="figure" id="id23" style="text-align: center">
<span id="fig-quic-client-migration"></span><p><img  src="None" alt="Figure made with TikZ" /></p>
<p><span class="caption-number">Fig. 84 </span><span class="caption-text">A QUIC connection migration initiated by the client</span></p>
</div><p>The examples above showed a connection that migrates from one network interface to another. This is expected to be a frequent situation for smartphones that move. However, there are also scenarios where the client can trigger a connection migration even if it uses a single network interface. First, the client application can decide to migrate its QUIC connection every <span class="math notranslate nohighlight">\(n\)</span> minutes. This could be useful for an application that provides a VPN-like service as proposed <span id="id9">[<a class="reference internal" href="biblio.html#id8897" title="Quentin De Coninck, François Michel, Maxime Piraux, Florentin Rochet, Thomas Given-Wilson, Axel Legay, Olivier Pereira, and Olivier Bonaventure. Pluginizing quic. In Proceedings of the ACM Special Interest Group on Data Communication, pages 59–74. 2019.">70</a>]</span>. By regularly changing their connection identifiers, such VPN services could prevent some middleboxes from detecting and blocking them. Another scenario are the unintended migrations caused by NAT.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unintended QUIC connection migrations</p>
<p>We have described how QUIC clients can trigger connection migrations. There are situations when connection migration occurs without being triggered by the client. A classical example is when there is a NAT on the path between the client and the server. The QUIC connection has been idle for some time and the NAT has removed the mapping from the client’s private IP address to a public one. When the client sends the next packet over the connection, the NAT creates a new mapping and thus assigns a different IP address to the client. The server receives a packet that uses the same connection identifier but comes from a different IP address than the initial one. This is illustrated in <a class="reference internal" href="#fig-quic-nat-migration"><span class="std std-numref">Fig. 85</span></a>. Upon reception of the QUIC packet coming from the new IP address (shown in red in <a class="reference internal" href="#fig-quic-nat-migration"><span class="std std-numref">Fig. 85</span></a>, the server triggers a path validation. Once the path has been validated, the QUIC connection can continue.</p>
</div>
<div class="figure" id="id24" style="text-align: center">
<span id="fig-quic-nat-migration"></span><p><img  src="None" alt="Figure made with TikZ" /></p>
<p><span class="caption-number">Fig. 85 </span><span class="caption-text">A QUIC connection migration triggered by a NAT</span></p>
</div><p>The previous examples have shown that a client can trigger a connection migration to improve performance or for privacy reasons. Our examples have considered that the clients can use different IP addresses while the servers have a stable IP address. This corresponds to most deployments, but not all of them. Today, many servers are dual-stack. They support both IPv4 and IPv6. When a client starts a QUIC connection over one address family, it could be useful for the client to learn the other server address to be able to switch to this address if the other fails. Another interesting type of deployments are the server farms where each server has both an anycast address and a unicast one. All servers use the same anycast address and this address is the one advertised using the DNS. When a client initiates a QUIC connection, it targets the anycast address. The <code class="docutils literal notranslate"><span class="pre">Initial</span></code> QUIC packet is load-balanced to one of the servers of the farm and all subsequent packets of this connection are load-balanced to the same server. In this deployment, all packets must be processed by the load-balancer before reaching the server. When the load is high, the load-balancer could become a bottleneck and it would be useful to allow QUIC connections to migrate to the unicast address of their servers since unicast address bypasses the load-balancer. The first version of QUIC provides partial support for this bypass by allowing the server to advertise its preferred unicast addresses (IPv4 and IPv6) using the <code class="docutils literal notranslate"><span class="pre">preferred_address</span></code> transport parameter during the handshake. However, according to QUIC specification <span id="id10">[<a class="reference internal" href="biblio.html#id8812" title="J. Iyengar (Ed.) and M. Thomson (Ed.). QUIC: A UDP-Based Multiplexed and Secure Transport. RFC 9000 (Proposed Standard), May 2021. URL: https://www.rfc-editor.org/rfc/rfc9000.txt, doi:10.17487/RFC9000.">25</a>]</span>, a client SHOULD, but is not forced to, migrate to one of the preferred addresses announced by the server. This migration can only be triggered by the client, there is no way for the server to impose a migration.</p>
</section>
<section id="multipath-extensions-for-quic">
<h2>Multipath extensions for QUIC<a class="headerlink" href="#multipath-extensions-for-quic" title="Permalink to this headline"></a></h2>
<p>QUIC’s connection migration features mainly cope with unexpected network events such as NAT rebinding or failovers. There are however other types of events which could benefit from true multipath capabilities. These include <cite>make before break</cite> handovers or aggregating different paths to obtain higher bandwidth or lower latency.</p>
<p>The Multipath extensions to QUIC <span id="id11">[<a class="reference internal" href="biblio.html#id8903" title="Yanmei Liu, Yunfei Ma, Quentin De Coninck, Olivier Bonaventure, Christian Huitema, and Mirja Kühlewind. Multipath Extension for QUIC. Internet-Draft draft-ietf-quic-multipath-02, Internet Engineering Task Force, July 2022. Work in Progress. URL: https://datatracker.ietf.org/doc/draft-ietf-quic-multipath/02/.">79</a>]</span> provide all the protocol mechanisms that are required by these scenarios. As other QUIC extensions, the utilization of the multipath extensions is negotiated by using the <code class="docutils literal notranslate"><span class="pre">enable_multipath</span></code> transport parameter during the handshake. The client proposed this transport parameter and if the server supports the multipath extensions, replies with a non-zero value for this transport parameter. In addition, the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> QUIC transport parameter also plays an important role for multipath. This transport parameter specifies the maximum number of connection identifiers that a QUIC implementation agrees to maintain during a connection. Since each path corresponds to a pair of connection identifiers, the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> restricts the number of paths that a Multipath QUIC connection will be able to use. The QUIC specification <span id="id12">[<a class="reference internal" href="biblio.html#id8812" title="J. Iyengar (Ed.) and M. Thomson (Ed.). QUIC: A UDP-Based Multiplexed and Secure Transport. RFC 9000 (Proposed Standard), May 2021. URL: https://www.rfc-editor.org/rfc/rfc9000.txt, doi:10.17487/RFC9000.">25</a>]</span> requires regular QUIC implementations to support at least two connection identifiers on each QUIC connection. <a class="reference internal" href="#fig-mpquic-tp"><span class="std std-numref">Fig. 86</span></a> illustrates the exchange of these transport parameters during a QUIC handshake. The client advertises its transport parameters in the ClientHello which is included in the CRYPTO frame of the Initial packet. The server returns its transport parameters in the TLS Encrypted Extensions that are included in its Handshake packet. By advertising <code class="docutils literal notranslate"><span class="pre">y</span></code> as its <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code>, the server indicates that it can manage up to <code class="docutils literal notranslate"><span class="pre">y</span></code> different connection identifies announced by the client. Similarly, the client can manage up to <code class="docutils literal notranslate"><span class="pre">x</span></code> connection identifiers announced by the server. Although the minimum value for the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> transport parameter is 2 in the QUIC specification <span id="id13">[<a class="reference internal" href="biblio.html#id8812" title="J. Iyengar (Ed.) and M. Thomson (Ed.). QUIC: A UDP-Based Multiplexed and Secure Transport. RFC 9000 (Proposed Standard), May 2021. URL: https://www.rfc-editor.org/rfc/rfc9000.txt, doi:10.17487/RFC9000.">25</a>]</span>, it can be expected that Multipath QUIC deployments will use large values.</p>
<div class="figure" id="id25" style="text-align: center">
<span id="fig-mpquic-tp"></span><p><img  src="None" alt="Figure made with TikZ" /></p>
<p><span class="caption-number">Fig. 86 </span><span class="caption-text">During the multipath QUIC handshake, client and server exchange the <code class="docutils literal notranslate"><span class="pre">enable_multipath</span></code> and <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> transport parameters</span></p>
</div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Current values of the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> transport parameters</p>
<p>As of October 2022, there is no real deployment of Multipath QUIC. A scan of some QUIC servers revealed the following utilization of this transport parameter:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">facebook.com</span></code>, <code class="docutils literal notranslate"><span class="pre">cloudflare.com</span></code>, <code class="docutils literal notranslate"><span class="pre">google.com</span></code> do not advertise the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> parameter</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">msquic.net</span></code> sets the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">4</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">quic.ngins.org</span></code> sets the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">haproxy.org</span></code> and <code class="docutils literal notranslate"><span class="pre">litespeedtech.com</span></code> set the <code class="docutils literal notranslate"><span class="pre">active_connection_id_limit</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">8</span></code></p></li>
</ul>
</div>
<div class="admonition-todo admonition" id="id14">
<p class="admonition-title">Todo</p>
<p>what are the current active_connection_id_limit used . unclear picoquic et quiche</p>
</div>
<p>With the current version of Multipath QUIC <span id="id15">[<a class="reference internal" href="biblio.html#id8903" title="Yanmei Liu, Yunfei Ma, Quentin De Coninck, Olivier Bonaventure, Christian Huitema, and Mirja Kühlewind. Multipath Extension for QUIC. Internet-Draft draft-ietf-quic-multipath-02, Internet Engineering Task Force, July 2022. Work in Progress. URL: https://datatracker.ietf.org/doc/draft-ietf-quic-multipath/02/.">79</a>]</span> only the client can create additional paths on a QUIC connection. This restriction was placed in the first version of Multipath QUIC because it is expected that most clients will be behind firewalls or NATs that already block the establishment of server-initiated paths. However, this restriction could be lifted in a future version of the protocol.</p>
<p>A Multipath QUIC connection can combine different paths. For Multipath QUIC, a network path is a four-tuple <span class="math notranslate nohighlight">\(IP_{src}\)</span>, <span class="math notranslate nohighlight">\(IP_{dst}\)</span>, <span class="math notranslate nohighlight">\(Port_{src}\)</span>, <span class="math notranslate nohighlight">\(Port_{dst}\)</span>. Two paths used on a Multipath QUIC connection must different by using at least one element of the four tuple.</p>
<p>The path used for the handshake is the initial path of a Multipath QUIC connection. This path is identified by using the connection identifiers chosen by the client and the server during the handshake. Once the QUIC connection has been established, both the client and the server can advertise additional connection identifiers using the <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame. Both the client and the server store the received connection identifiers in a table and can use them for connection migration and to create new paths for Multipath QUIC.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame does not only advertises new connection identifiers. It allows to manage the set of connection identifiers that are stored by the remote host. The <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame contains several sub-fields as shown in <a class="reference internal" href="#fig-mpquic-new-connection-id"><span class="std std-numref">Listing 22</span></a>. Each connection identifier is identified by its sequence number in the <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> frame.</p>
<div class="literal-block-wrapper docutils container" id="fig-mpquic-new-connection-id">
<div class="code-block-caption"><span class="caption-number">Listing 22 </span><span class="caption-text">The NEW_CONNECTION_ID frame</span><a class="headerlink" href="#fig-mpquic-new-connection-id" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">NEW_CONNECTION_ID Frame {</span>
<span class="go">       Type (i) = 0x18,</span>
<span class="go">       Sequence Number (i),</span>
<span class="go">       Retire Prior To (i),</span>
<span class="go">       Length (8),</span>
<span class="go">       Connection ID (8..160),</span>
<span class="go">       Stateless Reset Token (128)</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<p>QUIC also defines a <code class="docutils literal notranslate"><span class="pre">RETIRE_CONNECTION_ID</span></code> allowing a host to retire a connection identifier that it previously advertised to a peer. This frame only contains the sequence number of the connection identifier that needs to be removed.</p>
<div class="literal-block-wrapper docutils container" id="fig-mpquic-retire-connection-id">
<div class="code-block-caption"><span class="caption-number">Listing 23 </span><span class="caption-text">The RETIRE_CONNECTION_ID frame</span><a class="headerlink" href="#fig-mpquic-retire-connection-id" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">RETIRE_CONNECTION_ID Frame {</span>
<span class="go">       Type (i) = 0x19,</span>
<span class="go">       Sequence Number (i)</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<p>During the handshake, the client and the server agree on the connection identifiers   they they use to identify the connection in the incoming packets. The client identifies the CID selected by the server with sequence number 0 and similarly for the server. <a class="reference internal" href="#fig-mpquic-ncid-retire-cid"><span class="std std-numref">Fig. 87</span></a> illustrates the utilization of the <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> and <code class="docutils literal notranslate"><span class="pre">RETIRE_CONNECTION_ID</span></code> frames.</p>
<div class="figure" id="id26" style="text-align: center">
<span id="fig-mpquic-ncid-retire-cid"></span><p><img  src="None" alt="Figure made with TikZ" /></p>
<p><span class="caption-number">Fig. 87 </span><span class="caption-text">Thanks to the <code class="docutils literal notranslate"><span class="pre">NEW_CONNECTION_ID</span></code> and <code class="docutils literal notranslate"><span class="pre">RETIRE_CONNECTION_ID</span></code> frames, the client and the server can manage a list of available connection identifiers.</span></p>
</div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Support of zero-length connection identifiers with Multipath QUIC</p>
<p>QUIC version is already a complex protocol that supports many optional features. One of these is the support for zero-length connection identifiers. This feature is used by servers operated by hypergiants to reduce the per packet overhead when a server interacts with a smartphone or laptop that supports a small number of QUIC connections. These clients can easily rely on the UDP port numbers to identify the QUIC connection to which a received QUIC packet belongs. During the design of Multipath QUIC, there was a debate on whether zero-length connection identifiers should also be supported by Multipath QUIC. This creates some problems that are outside the scope of this introduction <span id="id16">[<a class="reference internal" href="biblio.html#id8902" title="Quentin De Coninck. The packet number space debate in multipath quic. ACM SIGCOMM Computer Communication Review, 52(3):2–9, 2022.">80</a>]</span>. In the end, zero-length connection identifiers are supported by Multipath QUIC <span id="id17">[<a class="reference internal" href="biblio.html#id8903" title="Yanmei Liu, Yunfei Ma, Quentin De Coninck, Olivier Bonaventure, Christian Huitema, and Mirja Kühlewind. Multipath Extension for QUIC. Internet-Draft draft-ietf-quic-multipath-02, Internet Engineering Task Force, July 2022. Work in Progress. URL: https://datatracker.ietf.org/doc/draft-ietf-quic-multipath/02/.">79</a>]</span>, but with some restrictions. In this document, we do not describe this restricted deployment and focus on the utilization of Multipath QUIC with real connection identifiers on both clients and servers.</p>
</div>
<p>To illustrate the creation of a new path on a Multipath QUIC connection, let us consider a smartphone connected to both Wi-Fi and cellular. The client has created a QUIC connection with a server using its Wi-Fi address, but it would like to create an additional path over the cellular interface. For this, the client first needs a local and a remote connection identifier to identify the new path. These identifiers can be obtained from the local and remote <span class="math notranslate nohighlight">\(List_{CID}\)</span> that are maintained for each connection. As for the connection migration feature, a new connection identifier cannot be used immediately. It must be validated. The client must perform path validation when it starts to use a new connection identifier on the cellular interface. Similarly, the server must validate the new path chosen by the client. This is illustrated on <a class="reference internal" href="#fig-mpquic-create-path"><span class="std std-numref">Fig. 88</span></a>. Once the path has been validated, it can be used to carry QUIC packets. To refuse the addition of a new path, the server simply refuses to respond to the <code class="docutils literal notranslate"><span class="pre">PATH_CHALLENGE</span></code> frame sent by the client.</p>
<div class="figure" id="id27" style="text-align: center">
<span id="fig-mpquic-create-path"></span><p><img  src="None" alt="Figure made with TikZ" /></p>
<p><span class="caption-number">Fig. 88 </span><span class="caption-text">To add a path to an existing connection, the client and the server select an available connection identifier and validate the new path.</span></p>
</div><p>Once a path has been validated, it is identified by the sequence number of the connection identifier used to send packets on this path. This path identifier is important because it unambiguously identifies a path and is used a a reference in several frames. For example, the <code class="docutils literal notranslate"><span class="pre">PATH_ABANDON</span></code> frame, which carries a path identifier, an error code and some additional information allows a peer to close a path. This frame can be sent over any of the available paths. In the example of <a class="reference internal" href="#fig-mpquic-create-path"><span class="std std-numref">Fig. 88</span></a>, if the smartphone looses its cellular interface, it would send <code class="docutils literal notranslate"><span class="pre">PATH_ABANDON(id=2,...)</span></code> over the Wi-Fi path. Upon reception of this frame, the server would know that it should stop sending packets over the cellular path.</p>
<div class="literal-block-wrapper docutils container" id="fig-mpquic-path-status">
<div class="code-block-caption"><span class="caption-number">Listing 24 </span><span class="caption-text">The PATH_STATUS frame</span><a class="headerlink" href="#fig-mpquic-path-status" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PATH_STATUS Frame {</span>
<span class="go">    Type (i) = TBD-03 (experiments use 0xbaba06),</span>
<span class="go">    Path Identifier (..),</span>
<span class="go">    Path Status sequence number (i),</span>
<span class="go">    Path Status (i),</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<p>The current Multipath QUIC draft <span id="id18">[<a class="reference internal" href="biblio.html#id8903" title="Yanmei Liu, Yunfei Ma, Quentin De Coninck, Olivier Bonaventure, Christian Huitema, and Mirja Kühlewind. Multipath Extension for QUIC. Internet-Draft draft-ietf-quic-multipath-02, Internet Engineering Task Force, July 2022. Work in Progress. URL: https://datatracker.ietf.org/doc/draft-ietf-quic-multipath/02/.">79</a>]</span> also defines a <code class="docutils literal notranslate"><span class="pre">PATH_STATUS</span></code> frame that allows a peer to indicate the status of a path. When a path is created, its status is set to <cite>Available</cite>. This indicates that the path can be used to send data. Using the <code class="docutils literal notranslate"><span class="pre">PATH_STATUS</span></code> frame, a peer can set the status of a path to <cite>Standby</cite>. In this case, the path should not be used to send non-probing packets until another <code class="docutils literal notranslate"><span class="pre">PATH_STATUS</span></code> frame switches it back to the <cite>Available</cite> state. Each <code class="docutils literal notranslate"><span class="pre">PATH_STATUS</span></code> frame carries a sequence number to cope with the loss of a <code class="docutils literal notranslate"><span class="pre">PATH_STATUS</span></code> frame.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>How does a client learn the server addresses ?</p>
<p>In the example above, the client created a path towards the address used by the server during the initial handshake. Many servers are dual-stack and have both an IPv4 and and IPv6 address. Given that the performance of the IPv4 and IPv6 paths sometimes differ and that they do not always fail simultaneously, it could be useful for a client to be able to create an additional path using the other address family. Furthermore, some servers have several IPv4 or IPv6 addresses, e.g. because they have several network interfaces in an enterprise network or because they belong to network that use IPv6 host-based multihoming <span id="id19">[<a class="reference internal" href="biblio.html#id8905" title="Maxime Piraux, Tom Barbette, Nicolas Rybowski, Louis Navarre, Thomas Alfroy, Cristel Pelsser, François Michel, and Olivier Bonaventure. The multiple roles that IPv6 addresses can play in today's Internet. ACM SIGCOMM Computer Communication Review, 52(3):10–18, 2022.">81</a>]</span>. When interacting with dual-stack servers, the client could obtain the server address in the other address family using the <cite>preferred_address</cite> transport parameter supported by QUIC version 1 <span id="id20">[<a class="reference internal" href="biblio.html#id8812" title="J. Iyengar (Ed.) and M. Thomson (Ed.). QUIC: A UDP-Based Multiplexed and Secure Transport. RFC 9000 (Proposed Standard), May 2021. URL: https://www.rfc-editor.org/rfc/rfc9000.txt, doi:10.17487/RFC9000.">25</a>]</span>. For multihomed servers, there are discussions on allowing servers to advertise their alternate addresses <span id="id21">[<a class="reference internal" href="biblio.html#id8904" title="Maxime Piraux and Olivier Bonaventure. Additional addresses for QUIC. Internet-Draft draft-piraux-quic-additional-addresses-00, Internet Engineering Task Force, October 2022. Work in Progress. URL: https://datatracker.ietf.org/doc/draft-piraux-quic-additional-addresses/00/.">82</a>]</span>.</p>
</div>
<p>To exchange data, Multipath QUIC associates a packet sequence number space to each path and defines a new <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frame that acknowledges the packets received over a given path. The <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frame contains the same information as QUIC’s <code class="docutils literal notranslate"><span class="pre">ACK</span></code> frame with a <cite>Packet Number Space Identifier</cite>. Thanks to this identifier, an <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frame can be sent over any path. For example, on a QUIC connection that uses a high bandwidth but long-delay satellite link and low delay but low bandwidth terrestrial link it is possible to send all the acknowledgment frames over the low delay link. Other policies to send acknowledgments are of course possible.</p>
<p>As QUIC version 1, Multipath QUIC adds a unique sequence number to each packet and acknowledges the packets received over each path using the <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frame <a class="reference internal" href="#fig-mpquic-ack-mp"><span class="std std-numref">Listing 25</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="fig-mpquic-ack-mp">
<div class="code-block-caption"><span class="caption-number">Listing 25 </span><span class="caption-text">The ACK_MP frame</span><a class="headerlink" href="#fig-mpquic-ack-mp" title="Permalink to this code"></a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ACK_MP Frame {</span>
<span class="go">    Type (i) = TBD-00..TBD-01 (experiments use 0xbaba00..0xbaba01),</span>
<span class="go">    Packet Number Space Identifier (i),</span>
<span class="go">    Largest Acknowledged (i),</span>
<span class="go">    ACK Delay (i),</span>
<span class="go">    ACK Range Count (i),</span>
<span class="go">    First ACK Range (i),</span>
<span class="go">    ACK Range (..) ...,</span>
<span class="go">    [ECN Counts (..)],</span>
<span class="go">}</span>
</pre></div>
</div>
</div>
<p>A Multipath QUIC data exchange is illustrated in <a class="reference internal" href="#fig-mpquic-data"><span class="std std-numref">Fig. 89</span></a>. We consider a smartphone connected to a server using Wi-Fi and cellular. The initial path was created using the Wi-Fi interface (the smartphone uses CID=:math:<cite>alpha</cite> and the server <span class="math notranslate nohighlight">\(\beta\)</span>). This path corresponds to the Packet Number Space Identifier <cite>0</cite> on both the smartphone and the server. The smartphone has later created a second path on its cellular interface. On this second path, the smartphone sends packets using the <span class="math notranslate nohighlight">\(\pi\)</span> CID and receives them with CID <span class="math notranslate nohighlight">\(\delta\)</span>. This path uses PNSI <cite>2</cite> on the server and <cite>1</cite> on the smartphone. The smartphone sends three packets on the cellular path and the second is lost. It then sends one packet over the Wi-Fi path. The server returns two <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frames over the Wi-Fi path. The first acknowledges the packets received over the cellular path (PNSI <cite>2</cite>). The second acknowledges the packets received over the Wi-Fi path (PNSI <cite>0</cite>). Upon reception of these acknowledgments, the client retransmits the frames that we included in the packet lost over the cellular path.</p>
<div class="figure" id="id28" style="text-align: center">
<span id="fig-mpquic-data"></span><p><img  src="None" alt="Figure made with TikZ" /></p>
<p><span class="caption-number">Fig. 89 </span><span class="caption-text">Multipath QUIC uses the <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frame to acknowledge packets on each path. The <code class="docutils literal notranslate"><span class="pre">ACK_MP</span></code> frame can be sent on any path since it carries a path identifier.</span></p>
</div><p>Multipath QUIC is still being discussed within the IETF. This section is likely to change in the coming months.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mptcp.html" class="btn btn-neutral float-left" title="Multipath TCP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mptcp-linux.html" class="btn btn-neutral float-right" title="Multipath TCP on recent Linux kernels" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Olivier Bonaventure.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>